!function(e,r){"object"==typeof exports&&"object"==typeof module?module.exports=r():"function"==typeof define&&define.amd?define([],r):"object"==typeof exports?exports.LS=r():e.LS=r()}(window,function(){return function(e){var r={};function n(t){if(r[t])return r[t].exports;var u=r[t]={i:t,l:!1,exports:{}};return e[t].call(u.exports,u,u.exports,n),u.l=!0,u.exports}return n.m=e,n.c=r,n.d=function(e,r,t){n.o(e,r)||Object.defineProperty(e,r,{enumerable:!0,get:t})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,r){if(1&r&&(e=n(e)),8&r)return e;if(4&r&&"object"==typeof e&&e&&e.__esModule)return e;var t=Object.create(null);if(n.r(t),Object.defineProperty(t,"default",{enumerable:!0,value:e}),2&r&&"string"!=typeof e)for(var u in e)n.d(t,u,function(r){return e[r]}.bind(null,u));return t},n.n=function(e){var r=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(r,"a",r),r},n.o=function(e,r){return Object.prototype.hasOwnProperty.call(e,r)},n.p="",n(n.s=0)}([function(e,r,n){"use strict";function t(e){var r=null,n=" let if then else func true false ";return{next:function(){var e=r;return r=null,e||s()},peek:p,eof:function(){return null===p()},croak:e.croak};function t(e){return/[0-9]/i.test(e)}function u(e){return/[a-z_]/i.test(e)}function a(e){return u(e)||"?!-<>=0123456789".indexOf(e)>=0}function o(e){return"+-*/%=&|<>!".indexOf(e)>=0}function f(e){return" \t\n".indexOf(e)>=0}function c(r){for(var n="";!e.eof()&&r(e.peek());)n+=e.next();return n}function i(){var e=c(a);return{type:function(e){return n.indexOf(" "+e+" ")>=0}(e)?"kw":"var",value:e}}function l(){return{type:"str",value:function(r){var n=!1,t="";for(e.next();!e.eof();){var u=e.next();if(n)t+=u,n=!1;else if("\\"===u)n=!0;else{if(u===r)break;t+=u}}return t}('"')}}function s(){if(c(f),e.eof())return null;var r=e.peek();return"#"===r?(c(function(e){return"\n"!==e}),e.next(),s()):'"'===r?l():t(r)?function(){var e=!1,r=c(function(r){return"."===r?!e&&(e=!0,!0):t(r)});return{type:"num",value:parseFloat(r)}}():u(r)?i():function(e){return",;(){}[]".indexOf(e)>=0}(r)?{type:"punc",value:e.next()}:o(r)?{type:"op",value:c(o)}:void e.croak("Cannot handle character: "+r)}function p(){return r||(r=s())}}n.r(r);var u={type:"bool",value:!1},a={"=":1,"||":2,"&&":3,"<":7,">":7,"<=":7,">=":7,"==":7,"!=":7,"+":10,"-":10,"*":20,"/":20,"%":20};function o(e){return function(){var r=[];for(;!e.eof();)r.push(f()),e.eof()||p(";");return{type:"prog",prog:r}}();function r(r,n,t,u){var a=[],o=!0;for(p(r);!e.eof()&&!i(n)&&(o?o=!1:p(t),!i(n));)a.push(u());return p(n),a}function n(){var r,n=t();return s("=")&&(e.next(),r=f()),{name:n,def:r}}function t(){var r=e.next();return"var"!==r.type&&e.croak("Expecting variable name"),r.value}function o(){return c(function(){if(i("(")){e.next();var a=f();return p(")"),a}if(i("{"))return function(){var e=r("{","}",";",f);return 0===e.length?u:1===e.length?e[0]:{type:"prog",prog:e}}();if(l("if"))return function(){v("if");var r=f();i("{")||v("then");var n={type:"if",cond:r,then:f()};return l("else")&&(e.next(),n.else=f()),n}();if(l("true")||l("false"))return{type:"bool",value:"true"===e.next().value};if(l("func"))return e.next(),{type:"func",name:"var"===e.peek().type?e.next().value:null,vars:r("(",")",",",t),body:f()};if(l("let"))return function(){if(v("let"),"var"===e.peek().type){var t=e.next().value,a=r("(",")",",",n);return{type:"call",func:{type:"func",name:t,vars:a.map(function(e){return e.name}),body:f()},args:a.map(function(e){return e.def||u})}}return{type:"let",vars:r("(",")",",",n),body:f()}}();var o=e.next();if("var"===o.type||"num"===o.type||"str"===o.type)return o;!function(){var r=JSON.stringify(e.peek());e.croak("Unexpected token: "+r)}()})}function f(){return c(function(){return function r(n,t){if(s()){var u=e.peek(),f=a[u.value];if(f>t){e.next();var c=r(o(),f),i={type:"="===u.value?"assign":"binary",operator:u.value,left:n,right:c};return r(i,t)}}return n}(o(),0)})}function c(e){var n=e();return i("(")?function(e){return{type:"call",func:e,args:r("(",")",",",f)}}(n):n}function i(r){var n=e.peek();return null!==n&&"punc"===n.type&&(!r||n.value===r)}function l(r){var n=e.peek();return null!==n&&"kw"===n.type&&(!r||n.value===r)}function s(r){var n=e.peek();return null!==n&&"op"===n.type&&(!r||n.value===r)}function p(r){i(r)?e.next():e.croak('Expecting punctuation: "'+r+'"')}function v(r){l(r)?e.next():e.croak('Expecting Keyword: "'+r+'"')}}var f=function(e){return o(t(function(e){var r=0,n=1,t=0;return{next:function(){var u=e.charAt(r++);return"\n"===u?(n++,t=0):t++,u},peek:u,eof:function(){return""===u()},croak:function(e){throw new Error(e+" ("+n+":"+t+")")}};function u(){return e.charAt(r)}}(e)))};function c(e){return r(e);function r(e){switch(e.type){case"num":case"str":case"bool":return function(e){return JSON.stringify(e.value)}(e);case"var":return function(e){return n(e.value)}(e);case"binary":return t(e);case"assign":return function(e){return t(e)}(e);case"let":return function(e){return 0===e.vars.length?r(e.body):"("+r({type:"call",func:{type:"func",vars:[e.vars[0].name],body:{type:"let",vars:e.vars.slice(1),body:e.body}},args:[e.vars[0].def||u]})+")"}(e);case"func":return function(e){var t,u="(function ";e.unguarded||(t=e.name||"LS_CC",u+=n(t));u+="("+e.vars.map(n).join(", ")+") {",e.locs&&e.locs.length>0&&(u+="var "+e.locs.join(", ")+";");e.unguarded||(u+="GUARD(arguments, "+t+"); ");return u+=" "+r(e.body)+" })"}(e);case"if":return function(e){return"("+r(e.cond)+" !== false ? "+r(e.then)+" : "+r(e.else||u)+")"}(e);case"prog":return function(e){return"("+e.prog.map(r).join(", ")+")"}(e);case"call":return function(e){return r(e.func)+"("+e.args.map(r).join(", ")+")"}(e);default:throw new Error("unexcepted: "+JSON.stringify(e))}}function n(e){return e}function t(e){return"("+r(e.left)+e.operator+r(e.right)+")"}}var i=0;function l(e){return void 0===e&&(e=""),"LS_"+e+i++}function s(e){switch(e.type){case"call":case"assign":return!0;case"num":case"str":case"bool":case"var":case"func":return!1;case"binary":return s(e.left)||s(e.right);case"if":return s(e.cond)||s(e.then)||e.else&&s(e.else);case"let":for(var r=0;r<e.vars.length;r++){var n=e.vars[r];if(n.def&&s(n.def))return!0}return s(e.body);case"prog":for(r=0;r<e.prog.length;r++)if(s(e.prog[r]))return!0;return!1}return!0}function p(e,r){return n(e,r);function n(e,r){switch(e.type){case"num":case"str":case"bool":case"var":return function(e,r){return r(e)}(e,r);case"assign":case"binary":return function(e,r){return n(e.left,function(t){return n(e.right,function(n){return r({type:e.type,operator:e.operator,left:t,right:n})})})}(e,r);case"let":return function(e,r){return 0===e.vars.length?n(e.body,r):n({type:"call",args:[e.vars[0].def||u],func:{type:"func",vars:[e.vars[0].name],body:{type:"let",vars:e.vars.slice(1),body:e.body}}},r)}(e,r);case"func":return function(e,r){var t=l("K"),u=n(e.body,function(e){return{type:"call",func:{type:"var",value:t},args:[e]}});return r({type:"func",name:e.name,vars:[t].concat(e.vars),body:u})}(e,r);case"if":return function(e,r){return n(e.cond,function(a){var o=l("I"),f=t(r);return r=function(e){return{type:"call",func:{type:"var",value:o},args:[e]}},{type:"call",func:{type:"func",vars:[o],body:{type:"if",cond:a,then:n(e.then,r),else:n(e.else||u,r)}},args:[f]}})}(e,r);case"prog":return function(e,r){return function e(t){return 0===t.length?r(u):1===t.length?n(t[0],r):s(t[0])?n(t[0],function(r){return s(r)?{type:"prog",prog:[r,e(t.slice(1))]}:e(t.slice(1))}):e(t.slice(1))}(e.prog)}(e,r);case"call":return function(e,r){return n(e.func,function(u){return function r(t,a){return a===e.args.length?{type:"call",func:u,args:t}:n(e.args[a],function(e){return t[a+1]=e,r(t,a+1)})}([t(r)],0)})}(e,r);default:throw new Error("Unknown type: "+JSON.stringify(e))}}function t(e){var r=l("R");return{type:"func",vars:[r],body:e({type:"var",value:r})}}}var v=function(){function e(e){void 0===e&&(e=null),this.vars=Object.create(e?e.vars:null),this.parent=e}return e.prototype.extend=function(){return new e(this)},e.prototype.lookup=function(e){for(var r=this;r;){if(Object.prototype.hasOwnProperty.call(r.vars,e))return r;r=r.parent}return null},e.prototype.get=function(e){if(e in this.vars)return this.vars[e];throw new Error("Undefiend variable: "+e)},e.prototype.set=function(e,r){var n=this.lookup(e);if(!n&&this.parent)throw new Error("Undefined varible "+e);return(n||this).vars[e]=r},e.prototype.def=function(e,r){return this.vars[e]=r},e}(),y={type:"bool",value:!1},g={type:"bool",value:!0};function d(e){var r,n;do{r=0,h(e),e=t(e)}while(r);return h(e),e;function t(e){if(r)return e;switch(e.type){case"num":case"str":case"bool":case"var":return e;case"binary":return function(e){if(e.left=t(e.left),e.right=t(e.right),a(e.left)&&a(e.right))switch(e.operator){case"+":return u(),{type:"num",value:o(e.left)+o(e.right)};case"-":return u(),{type:"num",value:o(e.left)-o(e.right)};case"*":return u(),{type:"num",value:o(e.left)*o(e.right)};case"/":return u(),{type:"num",value:o(e.left)/f(e.right)};case"%":return u(),{type:"num",value:o(e.left)%f(e.right)};case"<":return u(),{type:"bool",value:o(e.left)<o(e.right)};case">":return u(),{type:"bool",value:o(e.left)>o(e.right)};case"<=":return u(),{type:"bool",value:o(e.left)<=o(e.right)};case">=":return u(),{type:"bool",value:o(e.left)>=o(e.right)};case"==":return u(),e.left.type!==e.right.type?y:{type:"bool",value:e.left.value===e.right.value};case"!=":return u(),e.left.type!==e.right.type?g:{type:"bool",value:e.left.value!==e.right.value};case"||":return u(),!1!==e.left.value?e.left:e.right;case"&&":return u(),!1!==e.left.value?e.right:y}return e}(e);case"assign":return function(e){if("var"===e.left.type){if("var"===e.right.type&&e.right.def.cont)return u(),e.left.def.refs.forEach(function(r){r.value=e.right.value}),t(e.right);if(e.left.def.refs.length===e.left.def.assigned&&e.left.env.parent)return u(),t(e.right)}return e.left=t(e.left),e.right=t(e.right),e}(e);case"if":return function(e){if(e.cond=t(e.cond),e.then=t(e.then),e.else=t(e.else||y),a(e.cond))return u(),!1!==e.cond.value?e.then:e.else;return e}(e);case"prog":return function(e){if(0===e.prog.length)return u(),y;if(1===e.prog.length)return u(),t(e.prog[0]);if(!s(e.prog[0]))return u(),t({type:"prog",prog:e.prog.slice(1)});return 2===e.prog.length?{type:"prog",prog:e.prog.map(t)}:t({type:"prog",prog:[e.prog[0],{type:"prog",prog:e.prog.slice(1)}]})}(e);case"call":return function(e){var r=e.func;if("func"===r.type&&!r.name){if(r.env.parent.parent)return function(e){u();var r=e.func,a=e.args.map(t),o=t(r.body);function f(e){var t=e in n.env.vars?l(e+"$"):e;return n.locs.push(t),n.env.def(t,!0),r.env.get(e).refs.forEach(function(e){e.value=t}),t}var c=r.vars.map(function(e,r){return{type:"assign",operator:"=",left:{type:"var",value:f(e)},right:a[r]||y}});return r.locs.forEach(f),c.push(o),t({type:"prog",prog:c})}(e);r.unguarded=!0}return{type:"call",func:t(r),args:e.args.map(t)}}(e);case"func":return function(e){e:if("call"===e.body.type&&"var"===e.body.func.type&&0===e.body.func.def.assigned&&e.body.func.env.parent&&e.vars.indexOf(e.body.func.value)<0&&e.vars.length===e.body.args.length){for(var r=0;r<e.vars.length;r++){var a=e.body.args[r];if("var"!==a.type||a.value!==e.vars[r])break e}return u(),t(e.body.func)}e.locs=e.locs.filter(function(r){var n=e.env.get(r);return n.refs.length>0});var o=n;n=e,e.body=t(e.body),"call"===e.body.type&&(e.unguarded=!0);return n=o,e}(e)}throw new Error("unable to optimize "+JSON.stringify(e))}function u(){r++}function a(e){return"num"==e.type||"str"==e.type||"bool"==e.type}function o(e){if("num"!=e.type)throw new Error("Not a number: "+JSON.stringify(e));return e.value}function f(e){if(0==o(e))throw new Error("Division by zero: "+JSON.stringify(e));return e.value}}function h(e){var r=new v;return e.env=r,function e(n,t){switch(n.type){case"num":case"str":case"bool":case"raw":break;case"var":var u=t.lookup(n.value);u?n.env=u:(n.env=r,r.def(n.value,{refs:[],assigned:0}));var a=n.env.get(n.value);a.refs.push(n),n.def=a;break;case"assign":e(n.left,t),e(n.right,t),"var"===n.left.type&&n.left.def.assigned++;break;case"binary":e(n.left,t),e(n.right,t);break;case"if":e(n.cond,t),e(n.then,t),n.else&&e(n.else,t);break;case"prog":n.prog.forEach(function(r){e(r,t)});break;case"call":e(n.func,t),n.args.forEach(function(r){e(r,t)});break;case"func":n.env=t=t.extend(),n.name&&t.def(n.name,{refs:[],func:!0,assigned:0}),n.vars.forEach(function(e,r){t.def(e,{refs:[],farg:!0,assigned:0,cont:0===r})}),n.locs||(n.locs=[]),n.locs.forEach(function(e){t.def(e,{refs:[],floc:!0,assigned:0})}),e(n.body,t);break;default:throw new Error("Can't handle node "+JSON.stringify(n))}}(e,r),e.env}var b,m=!1;function x(e,r){if(--b<0)throw new w(r,e)}function w(e,r){this.f=e,this.args=r}function k(e,r){if(m)return e.apply(null,r);for(m=!0;;)try{b=200,e.apply(null,r);break}catch(n){if(!(n instanceof w))throw m=!1,n;e=n.f,r=n.args}m=!1}r.default=function(e){var r,n=function(e){var r=d(p(e,function(e){return{type:"call",func:{type:"var",value:"LS_TOPLEVEL"},args:[e]}})),n=c(r);if(n="var LS_TMP;\n\n"+n,r.env){var t=Object.keys(r.env.vars);t.length>0&&(n="var "+t.map(function(e){return c({type:"var",value:e})}).join(", ")+";\n\n"+n)}return n='"use strict";\n\n'+n}(f(e));return k(new Function("LS_TOPLEVEL, GUARD, Execute",n),[function(e){r=e},x,k]),r}}]).default});